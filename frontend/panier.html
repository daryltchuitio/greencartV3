<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenCart – Mon panier</title>
    <meta name="description" content="Récapitulatif de votre panier GreenCart : paniers anti-gaspi, locaux et de saison.">
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="logo-greencart.png">

</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WCPQVNVYLP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WCPQVNVYLP');
</script>
    
<script src="cart.js"></script>
<script src="auth-ui.js"></script>

<body>
    <a class="skip-link" href="#main">Aller au contenu principal</a>

    <!-- HEADER -->
    <header class="site-header">
        <div class="container header-content">
            <div class="logo">
                <img src="logo-greencart.png" alt="Logo GreenCart" />
                <span>GreenCart</span>
            </div>
            <nav aria-label="Navigation principale">
                <ul class="nav-list">
                    <li><a href="index.html#hero">Accueil</a></li>
                    <li><a href="catalogue.html">Catalogue</a></li>
                    <li><a href="producteurs.html">Producteurs</a></li>
                    <li>
                        <a href="panier.html" class="nav-cart-link">
                            Panier
                            <span class="cart-count cart-badge" aria-label="nombre d'articles dans le panier"></span>
                        </a>
                    </li>
                    <li><a href="apropos.html">À propos</a></li>
                    <li id="nav-auth">
                        <a href="connexion.html" class="btn-outline">Connexion</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- fil d’Ariane -->
     <nav class="breadcrumb" aria-label="Fil d’Ariane">
        <a href="index.html">Accueil</a>
        <span aria-hidden="true"> &gt; </span>
        <a href="catalogue.html">Catalogue</a>
        <span aria-hidden="true"> &gt; </span>
        <span>Panier</span>
    </nav>

    <!-- CONTENU PRINCIPAL -->
    <main id="main">
        <section class="cart-page">
            <div class="container cart-grid">

                <!-- Colonne gauche -->
                <section aria-labelledby="cart-title">
                    <h1 id="cart-title">Mon panier</h1>
                    <p class="section-intro">
                        Les produits affichés ici sont ceux ajoutés depuis le catalogue.
                    </p>

                    <div class="cart-items" id="cart-items"></div>

                    <p id="empty-cart" class="empty-cart">
                        Vous n'avez pas encore fait de choix de produit.
                        Rendez-vous sur le <a href="catalogue.html">catalogue</a> pour ajouter des paniers.
                    </p>
                </section>

                <!-- Colonne droite -->
                <aside class="cart-summary" aria-label="Récapitulatif de commande">
                    <h2>Récapitulatif</h2>
                    <div class="cart-summary-line">
                        <span>Sous-total</span>
                        <span id="subtotal">0,00 €</span>
                    </div>
                    <div class="cart-summary-line">
                        <span>Frais de service</span>
                        <span id="fees">0,00 €</span>
                    </div>
                    <div class="cart-summary-line cart-summary-total">
                        <span>Total à payer</span>
                        <span id="total">0,00 €</span>
                    </div>

                    <button type="button" class="btn-primary cart-button" id="validate-cart">
                        Valider mon panier
                    </button>

                    <p class="form-note">
                        Projet pédagogique : aucun paiement réel n’est effectué.
                    </p>
                </aside>

            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="container footer-grid">
            <div>
                <p><strong>GreenCart</strong> – Plateforme anti-gaspi & locale (projet pédagogique).</p>
                <p>© 2026 GreenCart. Tous droits réservés.</p>
            </div>
            <div class="footer-links">
                <a href="accessibilite.html">Accessibilité</a>
                <a href="cgv.html">CGU – CGV – Politique de confidentialité</a>
            </div>
        </div>
    </footer>

    <!-- SCRIPT PANIER -->
    <script>
        const CART_KEY_LOCAL = "greencart_cart";

        function getCart() {
            return JSON.parse(localStorage.getItem(CART_KEY_LOCAL) || "[]");
        }

        function saveCart(cart) {
            localStorage.setItem(CART_KEY_LOCAL, JSON.stringify(cart));
        }

        function updateTotals(cart) {
            const subtotal = cart.reduce((s, p) => s + p.price * p.qty, 0);
            const fees = cart.length > 0 ? 2.00 : 0.00;
            const total = subtotal + fees;

            document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " €";
            document.getElementById("fees").textContent = fees.toFixed(2) + " €";
            document.getElementById("total").textContent = total.toFixed(2) + " €";
        }

        function renderCart() {
            const cart = getCart();
            const cartItemsDiv = document.getElementById("cart-items");
            const emptyMsg = document.getElementById("empty-cart");

            cartItemsDiv.innerHTML = "";

            if (cart.length === 0) {
                emptyMsg.style.display = "block";
                updateTotals([]);
                return;
            }

            emptyMsg.style.display = "none";

            cart.forEach(item => {
                const article = document.createElement("article");
                article.className = "cart-item";

                article.innerHTML = `
                  <div class="cart-item-left">
                    <img src="${item.image}" alt="${item.name}" class="cart-img">
                    <div>
                      <h2>${item.name}</h2>
                      <p class="product-info">${item.description}</p>
                      <p class="cart-meta"><strong>Origine :</strong> ${item.origin}</p>
                      <p class="cart-meta"><strong>Producteur :</strong> ${item.producer}</p>
                    </div>
                  </div>
                  <div class="cart-item-right">
                    <p class="cart-price">${item.price.toFixed(2)} €</p>
                    <div class="qty-controls">
                      <button class="qty-btn" data-action="minus" data-id="${item.id}">−</button>
                      <span class="cart-qty">${item.qty}</span>
                      <button class="qty-btn" data-action="plus" data-id="${item.id}">+</button>
                    </div>
                    <button class="remove-btn" data-id="${item.id}">Supprimer</button>
                  </div>
                `;

                cartItemsDiv.appendChild(article);
            });

            updateTotals(cart);

            document.querySelectorAll(".qty-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.dataset.id;
                    const action = btn.dataset.action;
                    const cart = getCart();
                    const item = cart.find(p => p.id === id);
                    if (!item) return;

                    if (action === "plus") item.qty += 1;
                    if (action === "minus") item.qty -= 1;

                    if (item.qty <= 0) {
                        saveCart(cart.filter(p => p.id !== id));
                    } else {
                        saveCart(cart);
                    }
                    renderCart();
                });
            });

            document.querySelectorAll(".remove-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.dataset.id;
                    saveCart(getCart().filter(p => p.id !== id));
                    renderCart();
                });
            });
        }

        document.getElementById("validate-cart").addEventListener("click", () => {
            const cart = getCart();
            if (cart.length === 0) {
                alert("Votre panier est vide.");
                return;
            }
            const CURRENT_USER_KEY = "greencart_current_user";
            const userStr = localStorage.getItem(CURRENT_USER_KEY);
            if (!userStr) {
                alert("Vous devez être connecté en tant que consommateur pour valider une commande.");
                window.location.href = "connexion.html";
                return;
            }
            const user = JSON.parse(userStr);
            if (user.role !== "consommateur") {
                alert("Seuls les comptes consommateurs peuvent valider des commandes.");
                return;
            }
            
            // Création de la commande
            const ORDERS_KEY = "greencart_orders";
            const orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]");
            const subtotal = cart.reduce((s, p) => s + p.price * p.qty, 0);
            const fees = cart.length > 0 ? 2.00 : 0.00;
            const total = subtotal + fees;
            const newOrder = {
            id: Date.now().toString(),
            userId: user.id,
            date: new Date().toISOString(),
            items: cart,
            subtotal,
            fees,
            total,
            status: "en_preparation"  // statut initial
        };


            orders.push(newOrder);
            localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));

            // Vider le panier après commande
            saveCart([]);
            updateCartCount();
            alert("Votre commande a été enregistrée. Vous allez être redirigé vers votre espace consommateur.");
            window.location.href = "dashboard-consommateur.html";
        });

        updateCartCount();

        renderCart();

    </script>
</body>
</html>
