<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenCart – Catalogue des paniers locaux et anti-gaspi</title>
    <meta name="description" content="Découvrez les paniers GreenCart : paniers anti-gaspi, paniers locaux, offres spéciales familles et étudiants en France.">
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="logo-greencart.png">
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WCPQVNVYLP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WCPQVNVYLP');
</script>
    
<script src="cart.js"></script>
<script src="auth-ui.js"></script>

<div id="reviews-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="reviews-modal-title">
    <button type="button" class="modal-close" aria-label="Fermer">&times;</button>
    <h2 id="reviews-modal-title">Avis sur ce produit</h2>
    <div id="reviews-modal-content"></div>
  </div>
</div>

<body>
    <a class="skip-link" href="#main">Aller au contenu principal</a>

    <!-- HEADER -->
    <header class="site-header">
        <div class="container header-content">
            <div class="logo">
                <img src="logo-greencart.png" alt="Logo GreenCart" />
                <span>GreenCart</span>
            </div>
            <nav aria-label="Navigation principale">
                <ul class="nav-list">
                    <li><a href="index.html#hero">Accueil</a></li>
                    <li><a href="catalogue.html">Catalogue</a></li>
                    <li><a href="producteurs.html">Producteurs</a></li>
                    <li>
                        <a href="panier.html" class="nav-cart-link">
                            Panier
                            <span class="cart-count cart-badge" aria-label="nombre d'articles dans le panier"></span>
                        </a>
                    </li>
                    <li><a href="apropos.html">À propos</a></li>
                    <li id="nav-auth">
                        <a href="connexion.html" class="btn-outline">Connexion</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- fil d’Ariane -->
     <nav class="breadcrumb" aria-label="Fil d’Ariane">
      <a href="index.html">Accueil</a>
      <span aria-hidden="true"> &gt; </span>
      <span>Catalogue</span>
    </nav>

    <!-- CONTENU PRINCIPAL -->
    <main id="main">
        <section class="catalogue-page">
            <div class="container">
                <h1>Catalogue des paniers GreenCart</h1>
                <p class="section-intro">
                  Trouvez tout le catalogue de paniers proposés sur GreenCart ici. 
                </p>
                <!-- FILTRES -->
                 <div class="filters">
                    <select id="filter-category" class="filter-select">
                        <option value="all">Toutes les catégories</option>
                        <option value="anti-gaspi">Anti-gaspi</option>
                        <option value="etudiant">Étudiant</option>
                        <option value="famille">Famille</option>
                        <option value="terroir">Terroir</option>
                    </select>
                    <input
                    id="filter-search"
                    type="text"
                    class="filter-input"
                    placeholder="Rechercher un panier..."
                    >
                </div>
                <div class="catalogue-actions">
                    <a href="panier.html" class="btn-secondary">
                        Voir mon panier
                        <span class="cart-count cart-badge"></span>
                    </a>
                </div>       
                <div class="seo-intro">
                    <h2>Des paniers anti-gaspi et locaux toute l’année</h2>
                    <p>
                        Le catalogue GreenCart regroupe des paniers issus de producteurs locaux situés proches de chez vous.
                        Vous y trouverez des paniers de saison adaptés à tous les besoins :
                        paniers étudiants, paniers familles, paniers terroir, et paniers anti-gaspi disponibles à prix réduit.
                    </p>
                    <p>
                        Les paniers anti-gaspi permettent de sauver des invendus agricoles encore frais. Ils offrent une alternative
                        responsable et économique pour consommer local tout en limitant le gaspillage alimentaire. Chaque panier indique
                        sa catégorie, son prix et son mode de retrait (marché, point de collecte ou livraison locale).
                    </p>
                </div>


                <!-- LISTE DES PANIERS -->
                 <div class="catalogue-grid catalogue-list" id="catalogue-list">
                    <!-- Les produits seront injectés ici par JavaScript -->
</div>
</section>
</main>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="container footer-grid">
            <div>
                <p><strong>GreenCart</strong> – Plateforme anti-gaspi & locale (projet pédagogique).</p>
                <p>© 2026 GreenCart. Tous droits réservés.</p>
            </div>
            <div class="footer-links">
                <a href="accessibilite.html">Accessibilité</a>
                <a href="cgv.html">CGU – CGV – Politique de confidentialité</a>
            </div>
        </div>
    </footer>

<script>

// API pour cathaloque
const API_BASE = "http://localhost:4000";
async function apiGetProducts() {
  const res = await fetch(`${API_BASE}/api/products`);
  if (!res.ok) throw new Error("Erreur API /api/products");
  return await res.json();
}

async function apiGetProductReviews(productId) {
  const res = await fetch(`${API_BASE}/api/products/${productId}/reviews`);
  if (!res.ok) throw new Error("Erreur API /reviews");
  return await res.json();
}
// Fin API
document.addEventListener("DOMContentLoaded", () => {

  const filterCategory = document.getElementById('filter-category');
  const filterSearch = document.getElementById('filter-search');
  const listEl = document.getElementById("catalogue-list");
  const PRODUCER_PRODUCTS_KEY = "greencart_products";
  const REVIEWS_KEY = "greencart_reviews";
  const modal = document.getElementById("reviews-modal");
  const modalContent = document.getElementById("reviews-modal-content");
  const modalTitle = document.getElementById("reviews-modal-title");

  // Modif pour lire les avis d’un produit via l’API
async function openReviewsModal(productId) {
  if (!modal || !modalContent) return;

  modalContent.innerHTML = `<p class="form-note">Chargement des avis...</p>`;

  try {
    const reviews = await apiGetProductReviews(productId);

    modalContent.innerHTML = "";
    if (!Array.isArray(reviews) || reviews.length === 0) {
      modalContent.innerHTML = `<p class="form-note">Aucun avis pour ce produit pour le moment.</p>`;
    } else {
      reviews.forEach(r => {
        const card = document.createElement("article");
        card.className = "review-card";

        const d = new Date(r.createdAt || Date.now());
        const dateStr = d.toLocaleString("fr-FR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });

        const rating = typeof r.rating === "number" ? r.rating : 0;
        const rounded = Math.round(rating);
        const stars = "★".repeat(rounded) + "☆".repeat(5 - rounded);
        const author = r.user?.name || "Client GreenCart";

        card.innerHTML = `
          <p class="review-header">
            <strong>${author}</strong> – <span class="review-date">${dateStr}</span>
          </p>
          <p class="review-stars">${stars} <span class="review-score">(${rating.toFixed(1)}/5)</span></p>
          ${r.comment ? `<p class="review-comment">${r.comment}</p>` : ""}
        `;
        modalContent.appendChild(card);
      });
    }

    modal.setAttribute("aria-hidden", "false");
    modal.classList.add("open");
  } catch (err) {
    console.error(err);
    modalContent.innerHTML = `<p class="form-note">Impossible de charger les avis.</p>`;
    modal.setAttribute("aria-hidden", "false");
    modal.classList.add("open");
  }
}


  function closeReviewsModal() {
    if (!modal) return;
    modal.setAttribute("aria-hidden", "true");
    modal.classList.remove("open");
  }

  if (modal) {
    const backdrop = modal.querySelector(".modal-backdrop");
    const closeBtn = modal.querySelector(".modal-close");

    backdrop.addEventListener("click", closeReviewsModal);
    closeBtn.addEventListener("click", closeReviewsModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) {
        closeReviewsModal();
      }
    });
  }

  // clic sur "X avis"
  if (listEl) {
    listEl.addEventListener("click", (e) => {
      const ratingBtn = e.target.closest(".rating-link");
      if (ratingBtn) {
        const pid = ratingBtn.dataset.productId;
        openReviewsModal(pid);
      }
    });
  }

  // affichage des produits API (et leurs notes) dans la grille
  async function loadApiProducts() {
  if (!listEl) return;

  try {
    const products = await apiGetProducts();
    if (!Array.isArray(products)) return;

    products.forEach(p => {
      const article = document.createElement("article");
      article.className = "product-card";

      // IMPORTANT: on utilise l'id Mongo
      article.dataset.id = p._id;
      article.dataset.name = p.name;
      article.dataset.price = p.price;
      article.dataset.category = (p.category || "").toLowerCase(); // pour tes filtres
      article.dataset.origin = p.origin || "";
      article.dataset.producer = p.producer?.name || "Producteur local GreenCart";
      article.dataset.description = p.description || "";
      article.dataset.image = p.image || "panier-anti-gaspi-famille.png";
      article.dataset.region = p.region || "";
      article.dataset.dlc = p.dlc || "";

      const avg = Number(p.avgRating || 0);
      const count = Number(p.reviewsCount || 0);
      const rounded = Math.round(avg);
      const stars = "★".repeat(rounded) + "☆".repeat(5 - rounded);

      article.innerHTML = `
        <img src="${article.dataset.image}" alt="${p.name}" class="product-img">
        <h2>${p.name}</h2>
        <p class="product-info">${article.dataset.description}</p>
        <ul class="product-details">
          <li><strong>Origine :</strong> ${article.dataset.origin}</li>
          <li><strong>Producteur :</strong> ${article.dataset.producer}</li>
          ${article.dataset.region ? `<li><strong>Région :</strong> ${article.dataset.region}</li>` : ""}
          ${article.dataset.dlc ? `<li><strong>DLC :</strong> ${article.dataset.dlc}</li>` : ""}
          <li><strong>Catégorie :</strong> ${article.dataset.category}</li>
        </ul>
        <p class="product-price">${Number(article.dataset.price).toFixed(2)} €</p>

        <p class="product-rating">
          <span class="rating-stars">${stars}</span>
          <button type="button" class="rating-link" data-product-id="${p._id}">
            ${avg.toFixed(1)}/5 – ${count} avis
          </button>
        </p>

        <button class="btn-primary add-to-cart">Ajouter au panier</button>
      `;

      // On ajoute à la fin de la liste (après tes produits statiques)
      listEl.appendChild(article);
    });

  } catch (err) {
    console.error("Erreur loadApiProducts:", err);
  }
}

  // Charger les produits créés par les producteurs
  // -------------------------
  function loadProducerProducts() {
    const raw = localStorage.getItem(PRODUCER_PRODUCTS_KEY);
    if (!raw || !listEl) return;

    let products;
    try {
      products = JSON.parse(raw);
    } catch {
      return;
    }
    if (!Array.isArray(products)) return;

    products.forEach(p => {
      const article = document.createElement("article");
      article.className = "product-card";
      article.dataset.id = p.id;
      article.dataset.name = p.name;
      article.dataset.price = p.price;
      article.dataset.category = p.category;
      article.dataset.origin = p.origin;
      article.dataset.producer = p.producerName || "Producteur local GreenCart";
      article.dataset.description = p.description;
      article.dataset.image = p.image || "panier-anti-gaspi-famille.png";
      article.dataset.region = p.region || "";
      article.dataset.dlc = p.dlc || "";

      article.innerHTML = `
        <img src="${article.dataset.image}" alt="${p.name}" class="product-img">
        <h2>${p.name}</h2>
        <p class="product-info">${p.description}</p>
        <ul class="product-details">
          <li><strong>Origine :</strong> ${p.origin}</li>
          <li><strong>Producteur :</strong> ${article.dataset.producer}</li>
          ${p.region ? `<li><strong>Région :</strong> ${p.region}</li>` : ""}
          ${p.dlc ? `<li><strong>DLC :</strong> ${p.dlc}</li>` : ""}
          <li><strong>Catégorie :</strong> ${p.category}</li>
        </ul>
        <p class="product-price">${p.price.toFixed(2)} €</p>
        <button class="btn-primary add-to-cart">Ajouter au panier</button>
      `;
      listEl.appendChild(article);
    });
  }

  // loadProducerProducts(); (on ne charge plus les produits producteurs depuis le localStorage, car on les gère désormais via l’API backend)
  loadApiProducts(); // on charge d’abord les produits de l’API (qui incluent les produits producteurs + les produits statiques)

    // -------------------------
  // Affichage des notes moyennes
  // -------------------------
  function renderRatings() {
    let reviews;
    try {
      reviews = JSON.parse(localStorage.getItem(REVIEWS_KEY) || "[]");
    } catch {
      reviews = [];
    }
    if (!Array.isArray(reviews) || reviews.length === 0) return;

    // Calcul des stats par produit
    const stats = {};
    reviews.forEach(r => {
      if (!r.productId || typeof r.rating !== "number") return;
      if (!stats[r.productId]) {
        stats[r.productId] = { sum: 0, count: 0 };
      }
      stats[r.productId].sum += r.rating;
      stats[r.productId].count += 1;
    });

    const cards = document.querySelectorAll("#catalogue-list .product-card");
    cards.forEach(card => {
      const pid = card.dataset.id;
      if (!pid || !stats[pid]) return;

      const { sum, count } = stats[pid];
      const avg = sum / count;

      const rounded = Math.round(avg); // arrondi pour les étoiles
      const stars = "★".repeat(rounded) + "☆".repeat(5 - rounded);

      let ratingEl = card.querySelector(".product-rating");
      if (!ratingEl) {
        ratingEl = document.createElement("p");
        ratingEl.className = "product-rating";

        const priceEl = card.querySelector(".product-price");
        if (priceEl) {
          priceEl.insertAdjacentElement("afterend", ratingEl);
        } else {
          card.appendChild(ratingEl);
        }
      }

      ratingEl.innerHTML = `
      <span class="rating-stars">${stars}</span>
      <button 
      type="button" 
      class="rating-link" 
      data-product-id="${pid}">
      ${avg.toFixed(1)}/5 – ${count} avis
      </button>
      `;

    });
  }

    // renderRatings(); (API + backend gèrent les notes, donc plus besoin de ce rendu local)

  // -------------------------
  // FILTRES
  // -------------------------
  function applyFilters() {
    const category = filterCategory ? filterCategory.value : "all";
    const search = filterSearch ? filterSearch.value.toLowerCase() : "";

    const cards = document.querySelectorAll("#catalogue-list .product-card");

    cards.forEach((card) => {
      const cardCategory = card.dataset.category;
      const title = (card.dataset.name || card.querySelector("h2")?.textContent || "").toLowerCase();
      const info = (card.dataset.description || card.querySelector(".product-info")?.textContent || "").toLowerCase();

      const matchCategory = category === 'all' || category === cardCategory;
      const matchSearch = title.includes(search) || info.includes(search);

      card.style.display = (matchCategory && matchSearch) ? '' : 'none';
    });
  }

  if (filterCategory && filterSearch) {
    filterCategory.addEventListener('change', applyFilters);
    filterSearch.addEventListener('input', applyFilters);
  }

  // -------------------------
  // PANIER (localStorage)
  // -------------------------
  function getCart() {
    return JSON.parse(localStorage.getItem("greencart_cart") || "[]");
  }

  function saveCart(cart) {
    localStorage.setItem("greencart_cart", JSON.stringify(cart));
  }

  function addToCart(product) {
    const cart = getCart();
    const existing = cart.find(p => p.id === product.id);

    if (existing) {
      existing.qty += 1;
    } else {
      cart.push({ ...product, qty: 1 });
    }

    saveCart(cart);
    if (typeof updateCartCount === "function") {
      updateCartCount();
    }
    alert(product.name + " ajouté au panier !");
  }

  // Event delegation : un seul listener pour tout le catalogue
  if (listEl) {
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".add-to-cart");
      if (!btn) return;

      const card = btn.closest(".product-card");
      if (!card) return;

      const product = {
        id: card.dataset.id,
        name: card.dataset.name,
        price: parseFloat(card.dataset.price),
        origin: card.dataset.origin,
        producer: card.dataset.producer,
        description: card.dataset.description,
        image: card.dataset.image
      };

      addToCart(product);
    });
  }

  // Appliquer les filtres au chargement
  applyFilters();
});
</script>


</body>
</html>
